<!DOCTYPE html>
<html>
	<head>
		<title>cervii reloaded</title>
	</head>
	<body id="body" style="background-color: #000000;">
		<canvas id="c" style="margin: 20px; border: 1px solid #FFFFFF;"></canvas>
		<style>
* {
	margin: 0;
}
		</style>
		<script>
var body = document.getElementById("body");
var c = document.getElementById("c");
var ctx = c.getContext("2d");

var colors = [
	"#FF4040",
	"#40FF40"
];

var status;
var players;
var myNumber;
var interval;

var leftPressed = false;
var rightPressed = false;

window.onload = function() {
	c.width = 800;
	c.height = 800;

	ctx.fillStyle = "#303030";
	ctx.fillRect(0, 0, c.width, c.height);
}

window.onkeydown = function(event) {
	if (event.keyCode === 37) {
		leftPressed = true;
	} else if (event.keyCode === 39) {
		rightPressed = true;
	}
}

window.onkeyup = function(event) {
	if (event.keyCode === 37) {
		leftPressed = false;
	} else if (event.keyCode === 39) {
		rightPressed = false;
	}
}

var ws = new WebSocket("wss://home.jirik.us/cervii-reloaded-ws");
ws.onopen = function(event) {
	ws.send("R");
	status = "W";
}
ws.onmessage = function(event) {
	if (!processMsg(event.data)) {
		console.log("Invalid message: " + event.data);
	}
}
ws.onerror = function(event) {
	console.log("onerror!!");
}
ws.onclose = function(event) {
	console.log("onclose!!");
}

function processMsg(msg) {
	var parts = msg.split(" ");

	if (status === "W" && parts.length === 1 && parts[0] === "P") {
		ws.send("A");
		return true;
	} else if (status === "W" && parts.length === 8 && parts[0] === "S") {
		var mn = parseInt(parts[1]);
		if (isNaN(mn) || mn < 1 || mn > 2) {
			return false;
		}

		var ps = [];
		for (var i = 0; i < 2; i++) {
			var x = parseInt(parts[3 * i + 2]);
			var y = parseInt(parts[3 * i + 3]);
			var angle = parseInt(parts[3 * i + 4]);

			if (isNaN(x) || isNaN(y) || isNaN(angle) ||
			x < 0 || x >= 800 || y < 0 || y >= 800 || angle < 0 || angle >= 360) {
				return false;
			}

			ps.push({
				x: x,
				y: y,
				angle: angle * Math.PI / 180,
				color: colors[i]
			});
		}

		status = "S";
		players = ps;
		myNumber = mn;
		interval = setInterval(doMove, 100 / 3);
		return true;
	} else if (status === "S" && parts.length === 2 && (parts[0] === "0" || parts[0] === "1" || parts[0] === "2")) {
		var pnum = parseInt(parts[1]);
		if (isNaN(pnum) || pnum < 1 || pnum > players.length) {
			return false;
		}

		if (parts[0] === "1") {
			players[pnum - 1].angle -= 0.16;
		} else if(parts[0] === "2") {
			players[pnum - 1].angle += 0.16;
		}
		advancePlayer(pnum);
		return true;
	} else if (status === "S" && parts.length === 2 && parts[0] === "E") {
		clearInterval(interval);
		status = undefined;
		players = undefined;
		myNumber = undefined;
		interval = undefined;
		return true;
	} else {
		return false;
	}
}

function doMove() {
	if (leftPressed && !rightPressed) {
		players[myNumber - 1].angle -= 0.16;
		ws.send("1");
	} else if (rightPressed && !leftPressed) {
		players[myNumber - 1].angle += 0.16;
		ws.send("2");
	} else {
		ws.send("0");
	}

	advancePlayer(myNumber);
}

function advancePlayer(pnum) {
	var p = players[pnum - 1];

	var sin = Math.sin(p.angle);
	var cos = Math.cos(p.angle);

	ctx.fillStyle = p.color;
	for (var j = 0; j < 4; j++) {
		p.x += cos;
		p.y += sin;

		for (var k = -2; k <= 2; k++) {
			ctx.fillRect(Math.round(p.x + k * sin), Math.round(p.y - k * cos), 2, 2);
		}
	}
}
		</script>
	</body>
</html>
